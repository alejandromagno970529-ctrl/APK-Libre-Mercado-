// lib/widgets/emoji_picker_widget.dart - VERSIÃ“N OPTIMIZADA SIN OVERFLOW
import 'package:flutter/material.dart';

class EmojiPickerWidget extends StatefulWidget {
  final TextEditingController textEditingController;
  final VoidCallback onBackspacePressed;

  const EmojiPickerWidget({
    super.key,
    required this.textEditingController,
    required this.onBackspacePressed,
  });

  @override
  State<EmojiPickerWidget> createState() => _EmojiPickerWidgetState();
}

class _EmojiPickerWidgetState extends State<EmojiPickerWidget> {
  // Listas de emojis organizados por categorÃ­as
  final List<String> _recentEmojis = ['ğŸ˜€', 'ğŸ˜‚', 'â¤ï¸', 'ğŸ‘‹', 'ğŸ’•', 'ğŸ‰', 'ğŸ•', 'â˜•'];
  
  final List<String> _smileysEmojis = [
    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ¥²', 'â˜ºï¸',
    'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—',
    'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“',
    'ğŸ˜', 'ğŸ¥¸', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•',
    'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤',
    'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°',
    'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘',
    'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤',
    'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•',
    'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€',
    'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼',
    'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾'
  ];

  final List<String> _animalsEmojis = [
    'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯',
    'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’',
    'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡',
    'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸª²', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ',
    'ğŸœ', 'ğŸª°', 'ğŸª±', 'ğŸ¦Ÿ', 'ğŸ¦—', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¢', 'ğŸ',
    'ğŸ¦', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ',
    'ğŸŸ', 'ğŸ¬', 'ğŸ³', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦',
    'ğŸ¦§', 'ğŸ¦£', 'ğŸ˜', 'ğŸ¦›', 'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸ¦¬',
    'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–', 'ğŸ', 'ğŸ‘', 'ğŸ¦™', 'ğŸ', 'ğŸ¦Œ',
    'ğŸ•', 'ğŸ©', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸª¶', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ¦¤',
    'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¦¢', 'ğŸ¦©', 'ğŸ•Šï¸', 'ğŸ‡', 'ğŸ¦', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦«',
    'ğŸ¦¦', 'ğŸ¦¥', 'ğŸ', 'ğŸ€', 'ğŸ¿ï¸', 'ğŸ¦”', 'ğŸ¾'
  ];

  final List<String> _foodEmojis = [
    'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸ',
    'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ«', 'ğŸ¥', 'ğŸ…', 'ğŸ«’', 'ğŸ¥¥', 'ğŸ¥‘',
    'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸ¥’', 'ğŸ¥¬', 'ğŸ¥¦', 'ğŸ§„',
    'ğŸ§…', 'ğŸ„', 'ğŸ¥œ', 'ğŸŒ°', 'ğŸ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ«“', 'ğŸ¥¨', 'ğŸ¥¯',
    'ğŸ¥', 'ğŸ§‡', 'ğŸ§€', 'ğŸ–', 'ğŸ—', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•',
    'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ¥˜',
    'ğŸ²', 'ğŸ«•', 'ğŸ¥£', 'ğŸ¥—', 'ğŸ¿', 'ğŸ§ˆ', 'ğŸ§‚', 'ğŸ¥«', 'ğŸ±', 'ğŸ˜',
    'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ ', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥',
    'ğŸ¥®', 'ğŸ¡', 'ğŸ¥Ÿ', 'ğŸ¥ ', 'ğŸ¥¡', 'ğŸ¦ª', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©',
    'ğŸª', 'ğŸ‚', 'ğŸ°', 'ğŸ§', 'ğŸ¥§', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯'
  ];

  final List<String> _activitiesEmojis = [
    'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±',
    'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³',
    'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›¶',
    'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸', 'ğŸ¤¼', 'ğŸ¤¸', 'â›¹ï¸', 'ğŸ¤º', 'ğŸ¤¾',
    'ğŸŒï¸', 'ğŸ‡', 'ğŸ§˜', 'ğŸ„', 'ğŸŠ', 'ğŸ¤½', 'ğŸš£', 'ğŸ§—', 'ğŸš´', 'ğŸšµ',
    'ğŸ¯', 'ğŸª€', 'ğŸ®', 'ğŸ°', 'ğŸ²', 'ğŸ§©', 'â™Ÿï¸', 'ğŸ¨', 'ğŸ­', 'ğŸ¤',
    'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸ¥', 'ğŸª˜', 'ğŸ·', 'ğŸº', 'ğŸ¸', 'ğŸª•', 'ğŸ»'
  ];

  final List<Map<String, dynamic>> _categories = [
    {'name': 'Recientes', 'icon': 'ğŸ•’', 'emojis': []},
    {'name': 'Emoticonos', 'icon': 'ğŸ˜€', 'emojis': []},
    {'name': 'Animales', 'icon': 'ğŸ¶', 'emojis': []},
    {'name': 'Comida', 'icon': 'ğŸ•', 'emojis': []},
    {'name': 'Actividades', 'icon': 'âš½', 'emojis': []},
  ];

  int _selectedCategoryIndex = 0;

  @override
  void initState() {
    super.initState();
    // Inicializar las categorÃ­as con sus emojis
    _categories[0]['emojis'] = _recentEmojis;
    _categories[1]['emojis'] = _smileysEmojis;
    _categories[2]['emojis'] = _animalsEmojis;
    _categories[3]['emojis'] = _foodEmojis;
    _categories[4]['emojis'] = _activitiesEmojis;
  }

  void _addToRecent(String emoji) {
    if (!_recentEmojis.contains(emoji)) {
      setState(() {
        _recentEmojis.insert(0, emoji);
        if (_recentEmojis.length > 15) {
          _recentEmojis.removeLast();
        }
        _categories[0]['emojis'] = _recentEmojis;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final currentEmojis = _categories[_selectedCategoryIndex]['emojis'] as List<String>;

    return Container(
      height: 250, // Altura fija optimizada
      decoration: BoxDecoration(
        color: Colors.grey[50],
        border: Border(top: BorderSide(color: Colors.grey[300]!)),
        borderRadius: const BorderRadius.only(
          topLeft: Radius.circular(16),
          topRight: Radius.circular(16),
        ),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // Barra de categorÃ­as - COMPACTA
          Container(
            height: 40,
            padding: const EdgeInsets.symmetric(horizontal: 8),
            decoration: BoxDecoration(
              color: Colors.white,
              border: Border(bottom: BorderSide(color: Colors.grey[300]!)),
            ),
            child: ListView.builder(
              scrollDirection: Axis.horizontal,
              itemCount: _categories.length,
              itemBuilder: (context, index) {
                final category = _categories[index];
                final isSelected = index == _selectedCategoryIndex;
                
                return GestureDetector(
                  onTap: () {
                    setState(() {
                      _selectedCategoryIndex = index;
                    });
                  },
                  child: Container(
                    constraints: const BoxConstraints(minWidth: 60),
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                    margin: const EdgeInsets.symmetric(vertical: 6, horizontal: 2),
                    decoration: BoxDecoration(
                      color: isSelected ? Colors.blue[50] : Colors.transparent,
                      borderRadius: BorderRadius.circular(20),
                      border: Border.all(
                        color: isSelected ? Colors.blue : Colors.transparent,
                        width: 1.5,
                      ),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Text(
                          category['icon'],
                          style: const TextStyle(fontSize: 16),
                        ),
                        if (isSelected) ...[
                          const SizedBox(width: 4),
                          Text(
                            category['name'],
                            style: const TextStyle(
                              fontSize: 11,
                              color: Colors.blue,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ],
                      ],
                    ),
                  ),
                );
              },
            ),
          ),

          // Grid de emojis - COMPACTO Y EFICIENTE
          Expanded(
            child: Container(
              padding: const EdgeInsets.all(8),
              child: GridView.builder(
                gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: 8,
                  mainAxisSpacing: 4,
                  crossAxisSpacing: 4,
                  childAspectRatio: 1.0,
                ),
                itemCount: currentEmojis.length,
                itemBuilder: (context, index) {
                  final emoji = currentEmojis[index];
                  
                  return Material(
                    color: Colors.transparent,
                    borderRadius: BorderRadius.circular(8),
                    child: InkWell(
                      onTap: () {
                        widget.textEditingController.text += emoji;
                        _addToRecent(emoji);
                      },
                      borderRadius: BorderRadius.circular(8),
                      child: Container(
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(8),
                          color: Colors.transparent,
                        ),
                        child: Center(
                          child: Text(
                            emoji,
                            style: const TextStyle(fontSize: 22),
                          ),
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),
          ),

          // Barra inferior - MÃNIMA
          Container(
            height: 50,
            padding: const EdgeInsets.symmetric(horizontal: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              border: Border(top: BorderSide(color: Colors.grey[300]!)),
            ),
            child: Row(
              children: [
                // BotÃ³n de borrar
                InkWell(
                  onTap: widget.onBackspacePressed,
                  borderRadius: BorderRadius.circular(20),
                  child: Container(
                    width: 36,
                    height: 36,
                    decoration: BoxDecoration(
                      color: Colors.grey[100],
                      borderRadius: BorderRadius.circular(20),
                    ),
                    child: const Icon(Icons.backspace_outlined, size: 18, color: Colors.grey),
                  ),
                ),
                
                const Spacer(),
                
                // BotÃ³n de listo
                ElevatedButton(
                  onPressed: () {
                    Navigator.of(context).pop();
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.blue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 8),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(20),
                    ),
                  ),
                  child: const Text('Listo'),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}